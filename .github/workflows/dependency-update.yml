name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
    
    - name: Update requirements
      run: |
        pip-compile --upgrade requirements.in
        pip-compile --upgrade dev-requirements.in
    
    - name: Install updated dependencies
      run: |
        pip install -r requirements.txt
        pip install -r dev-requirements.txt
    
    - name: Run tests with updated dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libegl1-mesa \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          xvfb
        xvfb-run -a pytest spritepal/tests/ -m "not gui" --tb=short
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "ðŸ”„ Automated dependency updates"
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated updates to project dependencies.
          
          ### Changes
          - Updated Python package dependencies
          - All tests pass with updated dependencies
          
          ### Review Notes
          - Please review the changes carefully
          - Check for any breaking changes in updated packages
          - Ensure all functionality works as expected
          
          ---
          *This PR was created automatically by GitHub Actions*
        branch: chore/update-dependencies
        delete-branch: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit
    
    - name: Run security audit
      run: |
        echo "## Security Audit Report" > security-audit.md
        echo "Generated on: $(date)" >> security-audit.md
        echo "" >> security-audit.md
        
        echo "### Dependency Vulnerabilities (Safety)" >> security-audit.md
        safety check --output text >> security-audit.md || echo "No vulnerabilities found" >> security-audit.md
        echo "" >> security-audit.md
        
        echo "### Code Security Issues (Bandit)" >> security-audit.md
        bandit -r spritepal/ -f txt >> security-audit.md || echo "No security issues found" >> security-audit.md
    
    - name: Upload security audit
      uses: actions/upload-artifact@v4
      with:
        name: security-audit
        path: security-audit.md