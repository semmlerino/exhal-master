name: Mock Density Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'tests/**/*.py'
      - 'scripts/check_mock_density.py'
      - '.github/workflows/mock-density.yml'

jobs:
  mock-density:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparison

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install analysis dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ast-grep tokenize-rt

    - name: Analyze mock density
      id: mock-analysis
      run: |
        # Create results directory
        mkdir -p mock-density-results
        
        # Create mock density analysis script inline if it doesn't exist
        cat > scripts/check_mock_density.py << 'EOF'
        #!/usr/bin/env python3
        """
        Mock Density Analysis Tool
        
        Analyzes test files for mock usage density and identifies problematic patterns.
        """
        
        import argparse
        import ast
        import json
        import os
        import sys
        from collections import defaultdict
        from pathlib import Path
        from typing import Dict, List, Set, Tuple
        
        
        class MockDensityAnalyzer(ast.NodeVisitor):
            """Analyzes mock usage patterns in test files."""
            
            def __init__(self):
                self.mock_calls = 0
                self.total_lines = 0
                self.test_methods = 0
                self.mock_patterns = defaultdict(int)
                self.imports = set()
                self.deprecated_patterns = []
                
            def visit_Import(self, node):
                for alias in node.names:
                    self.imports.add(alias.name)
                self.generic_visit(node)
                
            def visit_ImportFrom(self, node):
                if node.module:
                    for alias in node.names:
                        full_name = f"{node.module}.{alias.name}"
                        self.imports.add(full_name)
                        if 'mock' in node.module.lower() or 'mock' in alias.name.lower():
                            self.mock_calls += 1
                self.generic_visit(node)
                
            def visit_Call(self, node):
                # Count mock-related function calls
                if hasattr(node.func, 'attr'):
                    attr_name = node.func.attr
                    if any(mock_term in attr_name.lower() for mock_term in ['mock', 'patch', 'magic']):
                        self.mock_calls += 1
                        self.mock_patterns[attr_name] += 1
                        
                elif hasattr(node.func, 'id'):
                    func_name = node.func.id
                    if any(mock_term in func_name.lower() for mock_term in ['mock', 'patch', 'magic']):
                        self.mock_calls += 1
                        self.mock_patterns[func_name] += 1
                
                # Check for deprecated MockFactory usage
                if (hasattr(node.func, 'attr') and 
                    hasattr(node.func, 'value') and 
                    hasattr(node.func.value, 'id') and 
                    node.func.value.id == 'MockFactory'):
                    self.deprecated_patterns.append({
                        'line': node.lineno,
                        'pattern': f"MockFactory.{node.func.attr}",
                        'type': 'deprecated_factory'
                    })
                
                self.generic_visit(node)
                
            def visit_FunctionDef(self, node):
                if node.name.startswith('test_'):
                    self.test_methods += 1
                self.generic_visit(node)
        
        
        def analyze_file(file_path: Path) -> Dict:
            """Analyze a single test file for mock density."""
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    
                tree = ast.parse(content, filename=str(file_path))
                analyzer = MockDensityAnalyzer()
                analyzer.total_lines = len(content.splitlines())
                analyzer.visit(tree)
                
                density = analyzer.mock_calls / analyzer.total_lines if analyzer.total_lines > 0 else 0
                
                return {
                    'file': str(file_path),
                    'mock_calls': analyzer.mock_calls,
                    'total_lines': analyzer.total_lines,
                    'test_methods': analyzer.test_methods,
                    'density': density,
                    'mock_patterns': dict(analyzer.mock_patterns),
                    'deprecated_patterns': analyzer.deprecated_patterns,
                    'imports': list(analyzer.imports)
                }
                
            except Exception as e:
                return {
                    'file': str(file_path),
                    'error': str(e),
                    'density': 0,
                    'mock_calls': 0,
                    'total_lines': 0
                }
        
        
        def analyze_changed_files(base_branch: str = 'origin/main') -> List[str]:
            """Get list of changed test files."""
            import subprocess
            try:
                result = subprocess.run([
                    'git', 'diff', '--name-only', base_branch, 'HEAD'
                ], capture_output=True, text=True, check=True)
                
                changed_files = [
                    f for f in result.stdout.strip().split('\n') 
                    if f.startswith('tests/') and f.endswith('.py')
                ]
                return changed_files
            except subprocess.CalledProcessError:
                # Fallback to all test files if git diff fails
                return []
        
        
        def main():
            parser = argparse.ArgumentParser(description='Analyze mock density in test files')
            parser.add_argument('--threshold-new', type=float, default=0.02, 
                              help='Density threshold for new files (default: 0.02)')
            parser.add_argument('--threshold-existing', type=float, default=0.01,
                              help='Density threshold for existing files (default: 0.01)')
            parser.add_argument('--output', '-o', help='Output JSON file')
            parser.add_argument('--github-actions', action='store_true',
                              help='Format output for GitHub Actions')
            parser.add_argument('--base-branch', default='origin/main',
                              help='Base branch for comparison')
            
            args = parser.parse_args()
            
            # Find all test files
            test_files = list(Path('tests').rglob('test_*.py'))
            if not test_files:
                print("No test files found")
                return 0
                
            # Analyze changed files vs all files
            changed_files = set(analyze_changed_files(args.base_branch))
            
            results = []
            violations = []
            
            for test_file in test_files:
                analysis = analyze_file(test_file)
                results.append(analysis)
                
                if 'error' in analysis:
                    continue
                    
                is_changed = str(test_file) in changed_files
                threshold = args.threshold_new if is_changed else args.threshold_existing
                
                if analysis['density'] > threshold:
                    violation_type = 'new_file' if is_changed else 'existing_file'
                    violations.append({
                        'file': analysis['file'],
                        'density': analysis['density'],
                        'threshold': threshold,
                        'type': violation_type,
                        'mock_calls': analysis['mock_calls'],
                        'deprecated_patterns': analysis['deprecated_patterns']
                    })
            
            # Generate report
            report = {
                'timestamp': '2025-08-06T00:00:00Z',  # Would be actual timestamp
                'total_files': len(test_files),
                'changed_files': len(changed_files),
                'violations': violations,
                'thresholds': {
                    'new_files': args.threshold_new,
                    'existing_files': args.threshold_existing
                },
                'summary': {
                    'total_violations': len(violations),
                    'avg_density': sum(r.get('density', 0) for r in results) / len(results) if results else 0,
                    'highest_density': max((r.get('density', 0) for r in results), default=0)
                },
                'detailed_results': results
            }
            
            # Save report
            if args.output:
                with open(args.output, 'w') as f:
                    json.dump(report, f, indent=2)
            
            # Print results
            if args.github_actions:
                print(f"::notice::Analyzed {len(test_files)} test files")
                print(f"::notice::Average mock density: {report['summary']['avg_density']:.4f}")
                
                for violation in violations:
                    level = "error" if violation['type'] == 'new_file' else "warning"
                    print(f"::{level} file={violation['file']}::"
                          f"Mock density {violation['density']:.4f} exceeds {violation['threshold']}")
                    
                    # Report deprecated patterns
                    for pattern in violation.get('deprecated_patterns', []):
                        print(f"::warning file={violation['file']},line={pattern['line']}::"
                              f"Deprecated pattern: {pattern['pattern']}")
            else:
                print(f"Mock Density Analysis Results:")
                print(f"Total files analyzed: {len(test_files)}")
                print(f"Changed files: {len(changed_files)}")
                print(f"Violations: {len(violations)}")
                print(f"Average density: {report['summary']['avg_density']:.4f}")
                
                if violations:
                    print("\nViolations:")
                    for v in violations:
                        print(f"  {v['file']}: {v['density']:.4f} > {v['threshold']}")
            
            # Exit with error code if there are violations in new files
            new_file_violations = [v for v in violations if v['type'] == 'new_file']
            return 1 if new_file_violations else 0
        
        
        if __name__ == '__main__':
            sys.exit(main())
        EOF
        
        chmod +x scripts/check_mock_density.py
        
        # Run mock density analysis
        python scripts/check_mock_density.py \
          --output mock-density-results/mock-density-report.json \
          --github-actions \
          --base-branch origin/${{ github.event.pull_request.base.ref || github.ref_name }}

    - name: Upload mock density results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: mock-density-results
        path: mock-density-results/
        retention-days: 30

    - name: Generate trend analysis (if historic data available)
      run: |
        # Create mock density trend report
        python -c "
        import json
        import os
        
        # This would normally pull from previous runs
        # For now, create a basic trend report
        trend_data = {
            'current_run': '$(date -Iseconds)',
            'trend': 'improving',  # Would be calculated from history
            'recommendation': 'Continue migration from MockFactory to RealComponentFactory'
        }
        
        with open('mock-density-results/trend-report.json', 'w') as f:
            json.dump(trend_data, f, indent=2)
        "

    - name: Comment on PR with mock density results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          try {
            const reportPath = 'mock-density-results/mock-density-report.json';
            if (!fs.existsSync(reportPath)) return;
            
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            
            let body = '## Mock Density Analysis\n\n';
            body += `ðŸ“Š **Summary**\n`;
            body += `- Files analyzed: ${report.total_files}\n`;
            body += `- Average density: ${report.summary.avg_density.toFixed(4)}\n`;
            body += `- Violations: ${report.summary.total_violations}\n\n`;
            
            if (report.violations.length > 0) {
              body += 'âš ï¸ **Violations Found**\n\n';
              body += '| File | Density | Threshold | Type |\n';
              body += '|------|---------|-----------|------|\n';
              
              report.violations.forEach(v => {
                const icon = v.type === 'new_file' ? 'ðŸ”´' : 'ðŸŸ¡';
                body += `| ${icon} ${v.file} | ${v.density.toFixed(4)} | ${v.threshold} | ${v.type} |\n`;
              });
              
              body += '\n**Recommendation**: Consider migrating from MockFactory to RealComponentFactory for better type safety and reduced mock density.\n';
            } else {
              body += 'âœ… **All checks passed!** Mock density is within acceptable limits.\n';
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## Mock Density Analysis')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
          } catch (error) {
            console.log('Error with mock density comment:', error.message);
          }